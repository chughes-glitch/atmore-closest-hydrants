<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>City of Atmore — Hydrant Navigator</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- Leaflet Routing Machine -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

  <!-- Better Measure Tool: Leaflet.PolylineMeasure (replaces old leaflet.measure) -->
  <link rel="stylesheet" href="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.css" />
  <script src="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.js"></script>

  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { padding: 12px 14px; border-bottom: 1px solid #e6e6e6; background:#fff; }
    h1 { font-size: 18px; margin: 0 0 8px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    input[type="text"] { flex: 1; min-width: 240px; padding: 10px; font-size: 16px; }
    button { padding: 10px 12px; font-size: 16px; cursor: pointer; }
    label { display: inline-flex; align-items: center; gap: 6px; font-size: 14px; color: #333; }
    #map { height: calc(100vh - 210px); }
    .panel { padding: 10px 14px; border-top: 1px solid #e6e6e6; background: #fafafa; }
    .card { background: #fff; border: 1px solid #e6e6e6; border-radius: 10px; padding: 10px; margin-top: 8px; }
    .muted { color: #666; font-size: 13px; }
    .big { font-size: 16px; }
    .btns { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#f2f2f2; font-size: 12px; margin-left: 6px; }
    .warn { color: #8a2b2b; }
    .navtwo { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; }
    .route-info { background: #e3f2fd; padding: 8px; border-radius: 8px; font-weight: bold; color: #1565c0; }
    a { text-decoration:none; }
  </style>
</head>
<body>

<header>
  <h1>City of Atmore — Hydrant Navigator</h1>

  <div class="row">
    <input id="addr" type="text" placeholder='Enter incident address (ex: "123 Main St, Atmore, AL")' />
    <button id="findBtn" type="button">Find Top 3 (Address)</button>
  </div>

  <div class="row" style="margin-top:10px;">
    <button id="gpsBtn" type="button">Start Live GPS (Always Follow)</button>
    <button id="measureBtn" type="button">Measure Hose Distance</button>

    <label><input id="autoGps" type="checkbox" checked /> Auto GPS on open</label>
    <label><input id="ringsToggle" type="checkbox" checked /> 300/600/1000 ft rings</label>
    <label><input id="showAllHydrants" type="checkbox" checked /> Show all hydrants</label>

    <span class="muted">Tip: Add “Atmore, AL” if a search misses.</span>
  </div>

  <div class="muted" id="statusLine"></div>
</header>

<div id="map"></div>

<div class="panel">
  <div class="muted">Results</div>
  <div id="routeInfo" class="route-info" style="display:none; margin-bottom:8px;"></div>
  <div id="out" class="card" style="display:none;"></div>
</div>

<script>
  const MAPBOX_ACCESS_TOKEN = 'pk.eyJ1IjoiY2h1Z2hlczU0MiIsImEiOiJjbWp4cnNoNXg1eGx5M2ZvYmU3MjVxMnJwIn0.PMa8r_GpVy_cq_FyZ9nxag';

  const HYDRANT_CSV_URL = "hydrants_for_google_my_maps.csv";
  const NOMINATIM_URL = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=";
  const DEFAULT_CENTER = [31.023, -87.493];
  const DEFAULT_ZOOM = 13;

  const map = L.map("map", { zoomControl: true }).setView(DEFAULT_CENTER, DEFAULT_ZOOM);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const hydrantLayer  = L.layerGroup().addTo(map);
  const top3Layer     = L.layerGroup().addTo(map);
  const incidentLayer = L.layerGroup().addTo(map);
  const userLayer     = L.layerGroup().addTo(map);
  const ringsLayer    = L.layerGroup().addTo(map);
  const routeLayer    = L.layerGroup().addTo(map);

  let hydrants = [];
  let gpsWatchId = null;
  let userMarker = null;
  let userAccuracyCircle = null;
  let firstGpsFix = true;
  let currentOrigin = null;
  let currentRouteControl = null;
  let fallbackRouteLine = null;
  let polylineMeasure = null;
  let isMeasuring = false;

  function setStatus(msg, warn = false) {
    const el = document.getElementById("statusLine");
    el.textContent = msg || "";
    el.className = "muted" + (warn ? " warn" : "");
  }

  /* ROUTING WITH MAPBOX (fixed for current API) */
  function clearRoute() {
    if (currentRouteControl) {
      map.removeControl(currentRouteControl);
      currentRouteControl = null;
    }
    if (fallbackRouteLine) {
      routeLayer.removeLayer(fallbackRouteLine);
      fallbackRouteLine = null;
    }
    document.getElementById("routeInfo").style.display = "none";
  }

  function drawFallbackRoute(userLat, userLon, incidentLat, incidentLon) {
    clearRoute();
    fallbackRouteLine = L.polyline([[userLat, userLon], [incidentLat, incidentLon]], {
      color: '#3388ff', weight: 6, opacity: 0.8
    }).addTo(routeLayer);
    document.getElementById("routeInfo").innerHTML = "En route: Straight-line (Mapbox unavailable)";
    document.getElementById("routeInfo").style.display = "block";
  }

  function drawRouteFromUserToIncident(userLat, userLon, incidentLat, incidentLon) {
    clearRoute();

    currentRouteControl = L.Routing.control({
      waypoints: [L.latLng(userLat, userLon), L.latLng(incidentLat, incidentLon)],
      routeWhileDragging: false,
      addWaypoints: false,
      draggableWaypoints: false,
      createMarker: () => null,
      lineOptions: { styles: [{ color: '#3388ff', weight: 6, opacity: 0.8 }] },
      show: false,
      router: L.Routing.mapbox(MAPBOX_ACCESS_TOKEN, { profile: 'mapbox/driving' })
    }).on('routesfound', e => {
      const route = e.routes[0];
      const minutes = Math.round(route.summary.totalTime / 60);
      const miles = (route.summary.totalDistance / 1609.34).toFixed(1);
      document.getElementById("routeInfo").innerHTML = `En route: ${minutes} min · ${miles} miles`;
      document.getElementById("routeInfo").style.display = "block";
    }).on('routingerror', () => {
      drawFallbackRoute(userLat, userLon, incidentLat, incidentLon);
    }).addTo(map);
  }

  /* MEASURE TOOL (using reliable PolylineMeasure) */
  function toggleMeasure() {
    if (isMeasuring) {
      if (polylineMeasure) polylineMeasure.disable();
      isMeasuring = false;
      document.getElementById("measureBtn").textContent = "Measure Hose Distance";
      setStatus("");
    } else {
      polylineMeasure = L.polylineMeasure.control({
        position: 'topleft',
        unit: 'feet',
        clearMeasurementsOnStop: false,
        showBearings: false,
        tooltipTextFinish: 'Click to <b>finish line</b>',
        tooltipTextDelete: 'Shift-click to <b>delete point</b>',
        tooltipTextMove: 'Click and drag to <b>move point</b><br>Ctrl-click for <b>bearing</b>',
        tooltipTextAdd: 'Click to <b>add point</b>',
        tooltipTextDrag: 'Drag to <b>move point</b>'
      }).addTo(map);
      isMeasuring = true;
      document.getElementById("measureBtn").textContent = "Stop Measuring";
      setStatus("Measuring hose distance: Click points on map (feet shown live).");
    }
  }

  /* Keep all other functions exactly as in the previous version (CSV, hydrants, top 3, GPS, etc.) */
  // ... (the rest of the script from the last full version I sent - everything after the measure toggle)

  // EVENTS
  document.getElementById("measureBtn").addEventListener("click", toggleMeasure);

  // ... (rest of events and boot)

  (async () => {
    await loadHydrants();
    if (document.getElementById("autoGps").checked) startGpsWatch();
  })();
</script>

</body>
</html>
